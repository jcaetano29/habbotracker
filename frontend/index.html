<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>HabboTracker ğŸ„ by Fungi</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Volkhov:ital,wght@0,400;0,700;1,400&family=Ubuntu+Mono:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg0:       #0d1117;
  --bg1:       #161b22;
  --bg2:       #1c2333;
  --bg3:       #21262d;
  --border:    #30363d;
  --border2:   #444c56;
  --gold:      #f0c040;
  --gold2:     #d4a017;
  --gold-dim:  rgba(240,192,64,.14);
  --gold-glow: 0 0 18px rgba(240,192,64,.35);
  --teal:      #4cc9b0;
  --teal-dim:  rgba(76,201,176,.12);
  --pink:      #e06c9f;
  --pink-dim:  rgba(224,108,159,.12);
  --red:       #e05252;
  --red-dim:   rgba(224,82,82,.12);
  --green:     #56d364;
  --green-dim: rgba(86,211,100,.12);
  --text:      #e6edf3;
  --text2:     #8b949e;
  --text3:     #6e7681;
  --r:         6px;
  --rl:        12px;
  --sans:      'Nunito', sans-serif;
  --mono:      'Ubuntu Mono', monospace;
  --disp:      'Volkhov', serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--sans);background:var(--bg0);color:var(--text);min-height:100vh;font-size:14px;line-height:1.5;overflow-x:hidden}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg1)}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
.app{display:flex;flex-direction:column;min-height:100vh;max-width:780px;margin:0 auto}

/* HEADER */
.header{position:sticky;top:0;z-index:100;height:58px;background:rgba(13,17,23,.93);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px}
.logo{font-family:var(--disp);font-size:22px;color:var(--gold);text-shadow:var(--gold-glow);letter-spacing:.5px;display:flex;align-items:center;gap:8px;user-select:none}
.logo-dot{width:8px;height:8px;border-radius:50%;background:var(--gold);box-shadow:var(--gold-glow);animation:pdot 2.5s ease-in-out infinite}
@keyframes pdot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}
.logo-sub{font-family:var(--mono);font-size:10px;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px}
.status-badge{font-family:var(--mono);font-size:11px;padding:4px 10px;border-radius:20px;border:1px solid;display:flex;align-items:center;gap:6px;transition:all .3s}
.status-badge.ok{color:var(--green);border-color:var(--green);background:var(--green-dim)}
.status-badge.err{color:var(--red);border-color:var(--red);background:var(--red-dim)}
.status-badge.wait{color:var(--text3);border-color:var(--border);background:transparent}
.status-dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.status-badge.ok .status-dot{animation:pdot 2s infinite}

/* NAV */
.nav{display:flex;background:var(--bg1);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none;position:sticky;top:58px;z-index:99}
.nav::-webkit-scrollbar{display:none}
.tab{flex:1;min-width:max-content;padding:0 16px;height:44px;font-family:var(--mono);font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;transition:all .2s;white-space:nowrap}
.tab:hover{color:var(--text);background:var(--bg2)}
.tab.active{color:var(--gold);border-bottom-color:var(--gold);background:var(--gold-dim)}

/* CONTENT */
.content{flex:1;padding:24px 20px 40px}
.screen{animation:fadeUp .25s ease both}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* COMPONENTS */
.section-title{font-family:var(--disp);font-size:20px;color:var(--gold);margin-bottom:20px;display:flex;align-items:center;gap:10px}
.section-title::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--gold2),transparent)}
.card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--rl);padding:16px;transition:border-color .2s}
.card:hover{border-color:var(--border2)}
.btn{font-family:var(--sans);font-weight:700;font-size:13px;padding:8px 18px;border-radius:var(--r);border:1px solid;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--gold);color:#0d1117;border-color:var(--gold)}
.btn-primary:hover{background:var(--gold2);border-color:var(--gold2);transform:translateY(-1px)}
.btn-secondary{background:transparent;color:var(--text2);border-color:var(--border)}
.btn-secondary:hover{border-color:var(--border2);color:var(--text)}
.btn-ghost{background:transparent;color:var(--text3);border-color:transparent;padding:6px 10px}
.btn-ghost:hover{color:var(--text);background:var(--bg3)}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}
.input{width:100%;background:var(--bg0);border:1px solid var(--border);border-radius:var(--r);color:var(--text);font-family:var(--sans);font-size:14px;padding:9px 12px;transition:border-color .2s,box-shadow .2s;outline:none}
.input:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-dim)}
.input::placeholder{color:var(--text3)}
textarea.input{resize:vertical;min-height:90px}
.label{display:block;font-family:var(--mono);font-size:11px;letter-spacing:.8px;text-transform:uppercase;color:var(--text3);margin-bottom:6px}
.form-group{margin-bottom:14px}
.err-box{background:var(--red-dim);border:1px solid var(--red);border-radius:var(--r);padding:10px 14px;color:var(--red);font-size:13px;margin-bottom:12px}
.tag{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:10px;letter-spacing:.5px;text-transform:uppercase;padding:2px 8px;border-radius:20px;border:1px solid}
.tag-gold{color:var(--gold);border-color:var(--gold2);background:var(--gold-dim)}
.tag-teal{color:var(--teal);border-color:var(--teal);background:var(--teal-dim)}
.tag-pink{color:var(--pink);border-color:var(--pink);background:var(--pink-dim)}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-center{display:flex;justify-content:center;padding:40px 0}
.empty-state{text-align:center;padding:48px 20px;color:var(--text3)}
.empty-state .emoji{font-size:36px;margin-bottom:12px}
.sort-btn{font-family:var(--mono);font-size:11px;letter-spacing:.5px;padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text3);cursor:pointer;transition:all .2s}
.sort-btn.active{color:var(--gold);border-color:var(--gold);background:var(--gold-dim)}
.sort-btn:hover:not(.active){border-color:var(--border2);color:var(--text)}

/* HOME */
.home-hero{text-align:center;padding:40px 0 32px}
.home-hero h1{font-family:var(--disp);font-size:38px;color:var(--gold);text-shadow:var(--gold-glow);line-height:1.1;margin-bottom:8px}
.home-hero p{color:var(--text2);font-size:14px}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:28px 0}
.stat-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--rl);padding:16px;text-align:center}
.stat-num{font-family:var(--disp);font-size:28px;color:var(--gold);line-height:1;margin-bottom:4px}
.stat-label{font-family:var(--mono);font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--text3)}
.top-item{display:flex;align-items:center;gap:10px;padding:8px 10px;cursor:pointer;transition:background .15s;border-radius:var(--r);margin:0 -10px}
.top-item:hover{background:var(--bg2)}
.top-rank{font-family:var(--mono);font-size:11px;color:var(--text3);width:24px;text-align:center}
.top-rank.gold{color:var(--gold);font-weight:700}
.top-rank.silver{color:#c0c0c0}
.top-rank.bronze{color:#cd7f32}
.top-name{flex:1;font-weight:700;font-size:13px}
.top-count{font-family:var(--mono);font-size:12px;color:var(--red)}
.home-cta{display:flex;gap:10px;margin-top:28px;justify-content:center}

/* PROFILE */
.search-bar{display:flex;gap:8px;margin-bottom:24px}
.search-bar .input{flex:1}
.profile-card{display:grid;grid-template-columns:auto 1fr;gap:16px;margin-bottom:20px}
.avatar-wrap{width:90px;height:120px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;display:flex;align-items:flex-end;justify-content:center;flex-shrink:0}
.avatar-wrap img{max-width:100%;max-height:100%;image-rendering:pixelated}
.profile-info{display:flex;flex-direction:column;justify-content:center;gap:6px}
.profile-name{font-family:var(--disp);font-size:22px;color:var(--text);line-height:1}
.profile-motto{font-style:italic;color:var(--text2);font-size:13px}
.profile-meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.badges-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
.badge-item{width:50px;height:50px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:default;transition:border-color .2s,transform .15s}
.badge-item:hover{border-color:var(--gold);transform:scale(1.1);z-index:1}
.badge-item img{width:40px;height:40px;image-rendering:pixelated}
.badge-empty{font-size:9px;color:var(--text3);text-align:center;padding:2px;word-break:break-all}
.friends-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-top:12px}
.friend-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:10px;text-align:center;cursor:pointer;transition:border-color .2s,transform .15s}
.friend-card:hover{border-color:var(--teal);transform:translateY(-2px)}
.friend-avatar{width:48px;height:64px;margin:0 auto 6px;background:var(--bg3);border-radius:4px;overflow:hidden;display:flex;align-items:flex-end;justify-content:center}
.friend-avatar img{max-width:100%;image-rendering:pixelated}
.friend-name{font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.friend-online{font-family:var(--mono);font-size:10px;margin-top:2px}
.friend-online.on{color:var(--green)}
.friend-online.off{color:var(--text3)}

/* FUNAS */
.funas-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px}
.funas-controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.funa-form{background:var(--bg1);border:1px solid var(--border);border-radius:var(--rl);padding:20px;margin-bottom:20px;animation:fadeUp .2s ease both}
.funa-form-title{font-family:var(--disp);font-size:17px;color:var(--gold);margin-bottom:16px}
.char-count{font-family:var(--mono);font-size:10px;color:var(--text3);text-align:right;margin-top:4px}
.char-count.warn{color:var(--pink)}
.optional-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.file-upload-area{border:1px dashed var(--border2);border-radius:var(--r);padding:12px;text-align:center;cursor:pointer;transition:all .2s;color:var(--text3);font-size:12px}
.file-upload-area:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-dim)}
.img-preview{position:relative;margin-top:8px;display:inline-block}
.img-preview img{max-width:100%;max-height:200px;border-radius:var(--r);border:1px solid var(--border);display:block}
.img-remove{position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;line-height:1}
.form-actions{display:flex;align-items:center;justify-content:space-between;margin-top:16px}
.filter-bar{display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:8px 12px;background:var(--bg2);border-radius:var(--r);border:1px solid var(--border);font-size:13px}
.filter-bar strong{color:var(--pink)}
.filter-clear{margin-left:auto}

/* FUNA CARD */
.funa-card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--rl);padding:16px;margin-bottom:12px;transition:border-color .2s;animation:fadeUp .2s ease both}
.funa-card:hover{border-color:var(--border2)}
.funa-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;gap:10px}
.funa-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.funa-author{font-family:var(--mono);font-size:12px;font-weight:700;color:var(--teal)}
.funa-author.anon{color:var(--text3);font-style:italic}
.funa-time{font-family:var(--mono);font-size:10px;color:var(--text3)}
.funa-target-wrap{display:flex;align-items:center;gap:6px;margin-bottom:8px}
.funa-target-label{font-size:11px;color:var(--text3)}
.funa-target{font-family:var(--mono);font-size:13px;font-weight:700;color:var(--pink);cursor:pointer}
.funa-target:hover{text-decoration:underline}
.funa-content{font-size:14px;color:var(--text);line-height:1.6;margin-bottom:10px;white-space:pre-wrap;word-break:break-word}
.funa-img{width:100%;max-height:360px;object-fit:contain;border-radius:var(--r);border:1px solid var(--border);margin-bottom:12px;cursor:pointer;transition:opacity .2s;display:block}
.funa-img:hover{opacity:.9}
.funa-footer{display:flex;align-items:center;gap:8px;padding-top:10px;border-top:1px solid var(--border)}
.vote-btn{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:transparent;cursor:pointer;font-family:var(--mono);font-size:12px;color:var(--text3);transition:all .2s}
.vote-btn:hover{border-color:var(--border2);color:var(--text)}
.vote-btn.voted-si{color:var(--green);border-color:var(--green);background:var(--green-dim)}
.vote-btn.voted-no{color:var(--red);border-color:var(--red);background:var(--red-dim)}
.vote-bar{flex:1;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;margin:0 4px}
.vote-bar-si{height:100%;border-radius:2px;background:var(--green);transition:width .4s ease}

/* PAGINATION */
.pagination{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:24px}
.page-btn{font-family:var(--mono);font-size:12px;padding:6px 14px;border-radius:var(--r);border:1px solid var(--border);background:transparent;color:var(--text3);cursor:pointer;transition:all .2s}
.page-btn:hover:not(:disabled){border-color:var(--gold);color:var(--gold)}
.page-btn.active{color:var(--gold);border-color:var(--gold);background:var(--gold-dim)}
.page-btn:disabled{opacity:.3;cursor:not-allowed}

/* LIGHTBOX */
.lightbox{position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.88);display:flex;align-items:center;justify-content:center;cursor:zoom-out;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.lightbox img{max-width:90vw;max-height:90vh;object-fit:contain;border-radius:var(--r);box-shadow:0 20px 60px rgba(0,0,0,.8)}
.lightbox-close{position:absolute;top:16px;right:16px;width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}

@media(max-width:500px){
  .content{padding:16px 12px 32px}
  .optional-row{grid-template-columns:1fr}
  .home-cta{flex-direction:column}
  .profile-card{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div>
      <div class="logo"><div class="logo-dot"></div>HabboTracker</div>
      <div class="logo-sub">by Fungi Â· habbo.es</div>
    </div>
    <div id="statusBadge" class="status-badge wait">
      <div class="status-dot"></div><span>conectando</span>
    </div>
  </header>

  <nav class="nav">
    <button class="tab active" data-tab="home"    onclick="setTab('home')">ğŸ  Inicio</button>
    <button class="tab"        data-tab="funas"   onclick="setTab('funas')">ğŸ”¥ Funas</button>
    <button class="tab"        data-tab="usuario" onclick="setTab('usuario')">ğŸ‘¤ Usuario</button>
  </nav>

  <main class="content" id="content"></main>
</div>

<div class="lightbox" id="lightbox" style="display:none" onclick="closeLightbox()">
  <button class="lightbox-close">âœ•</button>
  <img id="lightboxImg" src="" alt="">
</div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_BASE = (() => {
  const h = window.location.hostname;
  if (h === 'localhost' || h === '127.0.0.1') return 'http://localhost:3001';
  return 'https://habbotracker.onrender.com';
})();

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
  tab: 'home',
  home: { stats: null, loading: false },
  funas: {
    items: [], total: 0, page: 1, pages: 1,
    sort: 'new', targetFilter: null,
    loading: false, err: null,
    formOpen: false,
    formTarget: '', formContent: '', formHabbo: '',
    formFile: null, formPreview: null,
    formErr: null, formLoading: false,
  },
  user: {
    q: '', loading: false, err: null,
    profile: null, badges: null, friends: null, sub: 'info',
  },
};

// â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(path, opts = {}) {
  const res = await fetch(API_BASE + path, { signal: AbortSignal.timeout(12000), ...opts });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || `Error ${res.status}`);
  return data;
}

async function checkHealth() {
  const badge = document.getElementById('statusBadge');
  try {
    await api('/health');
    badge.className = 'status-badge ok';
    badge.innerHTML = '<div class="status-dot"></div><span>API OK</span>';
  } catch {
    badge.className = 'status-badge err';
    badge.innerHTML = '<div class="status-dot"></div><span>SIN API</span>';
  }
}

// â”€â”€â”€ ROUTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTab(tab) {
  S.tab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  if (tab === 'funas' && !S.funas.items.length && !S.funas.loading) loadFunas();
  if (tab === 'home'  && !S.home.stats && !S.home.loading) loadHomeStats();
  render();
}

function render() {
  const el = document.getElementById('content');
  const fn = { home: renderHome, funas: renderFunas, usuario: renderUsuario }[S.tab] || renderHome;
  el.innerHTML = `<div class="screen">${fn()}</div>`;
}

// â”€â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHome() {
  const st = S.home.stats;
  return `
    <div class="home-hero">
      <h1>HabboTracker</h1>
      <p>Explorador de la comunidad Habbo.es Â· No oficial</p>
    </div>

    ${S.home.loading ? `<div class="loading-center"><div class="spinner"></div></div>` : ''}

    ${st ? `
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-num">${st.totalFunas}</div><div class="stat-label">Funas</div></div>
      <div class="stat-card"><div class="stat-num">${st.conNombre}</div><div class="stat-label">Con firma</div></div>
      <div class="stat-card"><div class="stat-num">${st.conImagen}</div><div class="stat-label">Con imagen</div></div>
    </div>
    ${st.topFunados?.length ? `
    <div class="card" style="margin-top:0">
      <div style="font-family:var(--mono);font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:12px">ğŸ† MÃ¡s funados</div>
      ${st.topFunados.map((f,i) => `
        <div class="top-item" onclick="goFunasByTarget('${esc(f.name)}')">
          <div class="top-rank ${i===0?'gold':i===1?'silver':i===2?'bronze':''}">${i===0?'ğŸ‘‘':i+1}</div>
          <div class="top-name">${esc(f.name)}</div>
          <div class="top-count">ğŸ”¥ ${f.count}</div>
        </div>`).join('')}
    </div>` : ''}` : ''}

    <div class="home-cta">
      <button class="btn btn-primary" onclick="setTab('funas')">ğŸ”¥ Ver funas</button>
      <button class="btn btn-secondary" onclick="setTab('usuario')">ğŸ‘¤ Buscar usuario</button>
    </div>`;
}

async function loadHomeStats() {
  S.home.loading = true; render();
  try { S.home.stats = await api('/funas/stats'); } catch {}
  S.home.loading = false; render();
}

function goFunasByTarget(name) {
  S.funas.targetFilter = name; S.funas.page = 1;
  setTab('funas');
  loadFunas();
}

// â”€â”€â”€ FUNAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFunas() {
  const f = S.funas;
  return `
    <div class="funas-header">
      <div class="section-title" style="margin-bottom:0">ğŸ”¥ Funas</div>
      <div class="funas-controls">
        <button class="sort-btn ${f.sort==='new'?'active':''}" onclick="setSort('new')">Recientes</button>
        <button class="sort-btn ${f.sort==='top'?'active':''}" onclick="setSort('top')">MÃ¡s votadas</button>
        <button class="btn btn-primary" onclick="toggleFunaForm()">+ Nueva funa</button>
      </div>
    </div>

    ${f.targetFilter ? `
    <div class="filter-bar">
      ğŸ” Funas de: <strong>${esc(f.targetFilter)}</strong>
      <button class="btn-ghost btn filter-clear" onclick="clearTargetFilter()">âœ• Quitar filtro</button>
    </div>` : ''}

    ${f.formOpen ? renderFunaForm() : ''}

    ${f.loading ? `<div class="loading-center"><div class="spinner"></div></div>` :
      f.err    ? `<div class="err-box">${esc(f.err)}</div>` :
      f.items.length === 0 ? `<div class="empty-state"><div class="emoji">ğŸ˜¶</div><p>No hay funas todavÃ­a.<br>Â¡SÃ© el primero en publicar!</p></div>` :
      f.items.map(renderFunaCard).join('')}

    ${f.pages > 1 ? renderPagination(f.page, f.pages) : ''}`;
}

function renderFunaForm() {
  const f = S.funas;
  return `
  <div class="funa-form">
    <div class="funa-form-title">ğŸ“¢ Nueva funa</div>
    ${f.formErr ? `<div class="err-box">${esc(f.formErr)}</div>` : ''}
    <div class="optional-row">
      <div class="form-group">
        <label class="label">Â¿A quiÃ©n funas? (opcional)</label>
        <input class="input" id="fTarget" placeholder="Nombre en Habbo..." value="${esc(f.formTarget)}" oninput="S.funas.formTarget=this.value">
      </div>
      <div class="form-group">
        <label class="label">Tu nombre (opcional)</label>
        <input class="input" id="fHabbo" placeholder="AnÃ³nimo por defecto" value="${esc(f.formHabbo)}" oninput="S.funas.formHabbo=this.value">
      </div>
    </div>
    <div class="form-group">
      <label class="label">Denuncia <span style="color:var(--red)">*</span></label>
      <textarea class="input" id="fContent" placeholder="ContÃ¡ quÃ© pasÃ³... (mÃ­nimo 5 caracteres)" maxlength="500" oninput="S.funas.formContent=this.value;updateCharCount()">${esc(f.formContent)}</textarea>
      <div class="char-count" id="charCount">${f.formContent.length}/500</div>
    </div>
    <div class="form-group">
      <label class="label">Evidencia (imagen Â· opcional)</label>
      ${f.formPreview ? `
        <div class="img-preview">
          <img src="${f.formPreview}" alt="">
          <button class="img-remove" onclick="removeFormImg()">âœ•</button>
        </div>` : `
        <div class="file-upload-area" onclick="document.getElementById('fFile').click()">ğŸ“ Subir captura de pantalla</div>
        <input type="file" id="fFile" accept="image/*" style="display:none" onchange="handleFileSelect(event)">`}
    </div>
    <div class="form-actions">
      <button class="btn btn-secondary" onclick="toggleFunaForm()">Cancelar</button>
      <button class="btn btn-primary" onclick="submitFuna()" ${f.formLoading?'disabled':''}>
        ${f.formLoading ? '<div class="spinner" style="width:16px;height:16px;border-width:2px;margin:0"></div>' : 'ğŸ”¥ Publicar funa'}
      </button>
    </div>
  </div>`;
}

function renderFunaCard(funa) {
  const si = funa.votesSi || 0, no = funa.votesNo || 0, tot = si + no;
  const siPct = tot > 0 ? Math.round(si / tot * 100) : 50;
  return `
  <div class="funa-card">
    <div class="funa-header">
      <div class="funa-meta">
        ${funa.habboName ? `<span class="funa-author">ğŸ‘¤ ${esc(funa.habboName)}</span>` : `<span class="funa-author anon">ğŸ•µï¸ AnÃ³nimo</span>`}
        <span class="funa-time">${timeAgo(funa.createdAt)}</span>
      </div>
    </div>
    ${funa.target ? `
    <div class="funa-target-wrap">
      <span class="funa-target-label">Funa a:</span>
      <span class="funa-target" onclick="goFunasByTarget('${esc(funa.target)}')">${esc(funa.target)}</span>
    </div>` : ''}
    <div class="funa-content">${esc(funa.content)}</div>
    ${funa.imageUrl ? `<img class="funa-img" src="${API_BASE}${funa.imageUrl}" alt="Evidencia" onclick="openLightbox('${API_BASE}${funa.imageUrl}')" onerror="this.style.display='none'">` : ''}
    <div class="funa-footer">
      <button class="vote-btn ${funa.myVote==='si'?'voted-si':''}" onclick="vote('${funa.id}','si')">ğŸ‘ ${si}</button>
      <div class="vote-bar"><div class="vote-bar-si" style="width:${tot?siPct:50}%"></div></div>
      <button class="vote-btn ${funa.myVote==='no'?'voted-no':''}" onclick="vote('${funa.id}','no')">ğŸ‘ ${no}</button>
    </div>
  </div>`;
}

function renderPagination(page, pages) {
  const b = (label, p, disabled, active) =>
    `<button class="page-btn${active?' active':''}" onclick="goPage(${p})" ${disabled?'disabled':''}>${label}</button>`;
  let html = b('â€¹', page-1, page<=1, false);
  const s = Math.max(1, page-2), e = Math.min(pages, page+2);
  if (s > 1) html += b(1, 1, false, false) + (s>2?`<span style="color:var(--text3)">â€¦</span>`:'');
  for (let i=s;i<=e;i++) html += b(i,i,false,i===page);
  if (e < pages) html += (e<pages-1?`<span style="color:var(--text3)">â€¦</span>`:'') + b(pages,pages,false,false);
  html += b('â€º', page+1, page>=pages, false);
  return `<div class="pagination">${html}</div>`;
}

function setSort(s) { S.funas.sort=s; S.funas.page=1; render(); loadFunas(); }
function goPage(p)  { S.funas.page=p; loadFunas(); window.scrollTo(0,0); }
function clearTargetFilter() { S.funas.targetFilter=null; S.funas.page=1; loadFunas(); }

function toggleFunaForm() {
  S.funas.formOpen = !S.funas.formOpen;
  if (!S.funas.formOpen) {
    Object.assign(S.funas, { formTarget:'', formContent:'', formHabbo:'', formFile:null, formPreview:null, formErr:null, formLoading:false });
  }
  render();
}

function updateCharCount() {
  const el = document.getElementById('charCount');
  if (!el) return;
  const len = S.funas.formContent.length;
  el.textContent = `${len}/500`;
  el.className = 'char-count' + (len > 440 ? ' warn' : '');
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  S.funas.formFile = file;
  const reader = new FileReader();
  reader.onload = ev => { S.funas.formPreview = ev.target.result; render(); };
  reader.readAsDataURL(file);
}

function removeFormImg() { S.funas.formFile=null; S.funas.formPreview=null; render(); }

async function submitFuna() {
  const f = S.funas;
  if (!f.formContent.trim() || f.formContent.trim().length < 5) {
    f.formErr = 'El contenido debe tener al menos 5 caracteres'; render(); return;
  }
  f.formLoading = true; f.formErr = null; render();
  try {
    const fd = new FormData();
    fd.append('content', f.formContent.trim());
    if (f.formTarget.trim()) fd.append('target', f.formTarget.trim());
    if (f.formHabbo.trim())  fd.append('habboName', f.formHabbo.trim());
    if (f.formFile)          fd.append('image', f.formFile, f.formFile.name);

    const res = await fetch(API_BASE + '/funas', { method: 'POST', body: fd });
    const d = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(d.error || `Error ${res.status}`);

    f.items.unshift(d); f.total++;
    Object.assign(f, { formOpen:false, formTarget:'', formContent:'', formHabbo:'', formFile:null, formPreview:null, formErr:null });
    S.home.stats = null; // refresh stats
    render();
  } catch (e) { f.formErr = e.message; }
  f.formLoading = false; render();
}

async function loadFunas() {
  const f = S.funas;
  f.loading = true; f.err = null; render();
  try {
    const p = new URLSearchParams({ page: f.page, sort: f.sort });
    if (f.targetFilter) p.set('target', f.targetFilter);
    const data = await api('/funas?' + p);
    Object.assign(f, { items: data.items, total: data.total, page: data.page, pages: data.pages });
  } catch (e) { f.err = e.message; }
  f.loading = false; render();
}

async function vote(funaId, v) {
  try {
    const data = await api(`/funas/${funaId}/vote`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ vote: v })
    });
    const funa = S.funas.items.find(f => f.id === funaId);
    if (funa) { funa.votesSi = data.votesSi; funa.votesNo = data.votesNo; funa.myVote = data.myVote; render(); }
  } catch (e) { console.error(e.message); }
}

// â”€â”€â”€ USUARIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUsuario() {
  const u = S.user;
  return `
    <div class="section-title">ğŸ‘¤ Usuario</div>
    <div class="search-bar">
      <input class="input" id="userSearch" placeholder="Nombre en Habbo.es..." value="${esc(u.q)}"
        oninput="S.user.q=this.value" onkeydown="if(event.key==='Enter')searchUser()">
      <button class="btn btn-primary" onclick="searchUser()">Buscar</button>
    </div>
    ${u.loading ? `<div class="loading-center"><div class="spinner"></div></div>` :
      u.err     ? `<div class="err-box">${esc(u.err)}</div>` :
      u.profile ? renderUserProfile() : `<div class="empty-state"><div class="emoji">ğŸ”</div><p>IngresÃ¡ un nombre para buscar un jugador</p></div>`}`;
}

function renderUserProfile() {
  const u = S.user, p = u.profile;
  const fig  = p.figureString || p.habboFigure || '';
  const name = p.name || p.habboName || '';
  return `
  <div class="card profile-card">
    <div class="avatar-wrap">
      ${fig ? `<img src="${API_BASE}/avatar?figure=${encodeURIComponent(fig)}&size=l" alt="${esc(name)}" onerror="this.style.display='none'">` : ''}
    </div>
    <div class="profile-info">
      <div class="profile-name">${esc(name)}</div>
      ${p.motto ? `<div class="profile-motto">"${esc(p.motto)}"</div>` : ''}
      <div class="profile-meta">
        ${p.memberSince  ? `<span class="tag tag-teal">ğŸ“… ${p.memberSince.slice(0,10)}</span>` : ''}
        ${p.online != null ? `<span class="tag ${p.online?'tag-gold':''}">${p.online?'ğŸŸ¢ En lÃ­nea':'âš« Offline'}</span>` : ''}
        ${p.starPlayerScore != null ? `<span class="tag tag-pink">â­ ${p.starPlayerScore}</span>` : ''}
      </div>
      <div style="margin-top:8px">
        <button class="btn btn-secondary" style="font-size:12px;padding:6px 12px" onclick="prefillFuna('${esc(name)}')">ğŸ”¥ Funar a este usuario</button>
      </div>
    </div>
  </div>
  <div style="display:flex;gap:8px;margin:16px 0">
    <button class="sort-btn ${u.sub==='info'   ?'active':''}" onclick="setUserSub('info')">Info</button>
    <button class="sort-btn ${u.sub==='badges' ?'active':''}" onclick="setUserSub('badges')">Placas</button>
    <button class="sort-btn ${u.sub==='friends'?'active':''}" onclick="setUserSub('friends')">Amigos</button>
  </div>
  ${u.sub==='badges'?renderBadges():u.sub==='friends'?renderFriends():renderUserInfo()}`;
}

function renderUserInfo() {
  const p = S.user.profile;
  const rows = [
    ['Nivel', p.currentLevel],
    ['Puntos logro', p.totalExperience ?? p.achievementScore],
    ['Miembro desde', p.memberSince?.slice(0,10)],
    ['Ãšltimo acceso', p.lastAccessTime?.slice(0,10)],
  ].filter(([,v]) => v != null && v !== '');
  if (!rows.length) return `<div class="empty-state"><div class="emoji">ğŸ“­</div><p>Sin info adicional</p></div>`;
  return `<div class="card">${rows.map(([k,v])=>`
    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="color:var(--text3);font-family:var(--mono);font-size:12px">${k}</span>
      <span style="font-weight:700">${esc(String(v))}</span>
    </div>`).join('')}</div>`;
}

function renderBadges() {
  const u = S.user;
  if (u.badges === null) { loadUserBadges(); return `<div class="loading-center"><div class="spinner"></div></div>`; }
  if (!u.badges.length) return `<div class="empty-state"><div class="emoji">ğŸ…</div><p>Sin placas visibles</p></div>`;
  return `<div class="card"><div class="badges-grid">${u.badges.map(b => {
    const code = b.code || b.badgeCode || '';
    return `<div class="badge-item" title="${esc(b.name||b.badgeName||code)}">
      ${code ? `<img src="${API_BASE}/badge/${code}" alt="${esc(code)}" onerror="this.innerHTML='<div class=badge-empty>${esc(code)}</div>';this.style.border='none'">` : '<div class="badge-empty">?</div>'}
    </div>`;
  }).join('')}</div></div>`;
}

function renderFriends() {
  const u = S.user;
  if (u.friends === null) { loadUserFriends(); return `<div class="loading-center"><div class="spinner"></div></div>`; }
  if (!u.friends.length) return `<div class="empty-state"><div class="emoji">ğŸ‘¥</div><p>Sin amigos visibles</p></div>`;
  return `<div class="friends-grid">${u.friends.map(f => {
    const fig = f.figureString || f.habboFigure || '';
    const nm = f.name || f.habboName || '';
    return `<div class="friend-card" onclick="loadFriendProfile('${esc(nm)}')">
      <div class="friend-avatar">${fig?`<img src="${API_BASE}/avatar?figure=${encodeURIComponent(fig)}&size=s" alt="" onerror="this.style.display='none'">`:''}</div>
      <div class="friend-name">${esc(nm)}</div>
      <div class="friend-online ${f.online?'on':'off'}">${f.online?'ğŸŸ¢ En lÃ­nea':'âš« Offline'}</div>
    </div>`;
  }).join('')}</div>`;
}

async function searchUser() {
  const q = S.user.q.trim();
  if (!q) return;
  Object.assign(S.user, { loading:true, err:null, profile:null, badges:null, friends:null, sub:'info' });
  render();
  try { S.user.profile = await api(`/api/users/${encodeURIComponent(q)}/profile`); }
  catch (e) { S.user.err = e.message; }
  S.user.loading = false; render();
}

async function loadUserBadges() {
  const name = S.user.profile?.name || S.user.profile?.habboName || S.user.q;
  if (!name) { S.user.badges = []; return; }
  try {
    // Los badges vienen dentro del perfil en Habbo
    const data = await api(`/api/users/${encodeURIComponent(name)}/profile`);
    S.user.badges = data.selectedBadges || data.badges || [];
  } catch { S.user.badges = []; }
  render();
}

async function loadUserFriends() {
  const name = S.user.profile?.name || S.user.profile?.habboName || S.user.q;
  if (!name) { S.user.friends = []; return; }
  try {
    const data = await api(`/api/users/${encodeURIComponent(name)}/friends`);
    S.user.friends = Array.isArray(data) ? data : (data.friends || []);
  } catch { S.user.friends = []; }
  render();
}

function setUserSub(sub) { S.user.sub = sub; render(); }
function loadFriendProfile(name) {
  S.user.q = name; Object.assign(S.user, { profile:null, badges:null, friends:null, sub:'info' });
  searchUser();
}

function prefillFuna(name) {
  S.funas.formOpen = true; S.funas.formTarget = name;
  setTab('funas');
  setTimeout(() => document.getElementById('fContent')?.focus(), 100);
}

// â”€â”€â”€ LIGHTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLightbox(src) {
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
function closeLightbox() {
  document.getElementById('lightbox').style.display = 'none';
  document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeLightbox(); });

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function timeAgo(ts) {
  const m = Math.floor((Date.now() - ts) / 60000);
  if (m < 1) return 'ahora';
  if (m < 60) return `hace ${m}m`;
  const h = Math.floor(m / 60);
  if (h < 24) return `hace ${h}h`;
  const d = Math.floor(h / 24);
  if (d < 30) return `hace ${d}d`;
  return new Date(ts).toLocaleDateString('es-ES', { day:'numeric', month:'short' });
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
checkHealth();
loadHomeStats();
</script>
</body>
</html>
