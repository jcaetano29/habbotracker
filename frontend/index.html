<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>HabboTracker ğŸ„ by Fungi</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&family=Ubuntu+Condensed&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Paleta extraÃ­da de Habbo.es
   Header:   #1f4d73  (azul petrÃ³leo oscuro)
   Nav:      #2a6496  (azul medio)
   Accent:   #3b9fd4  (azul cielo)
   BG page:  #e8eff5  (gris azulado claro)
   BG card:  #ffffff
   Border:   #c5d8e8
   Yellow:   #f9c000  (logo Habbo)
   Green:    #5cb85c  (CTA jugar)
   Text:     #2d3f50
   Text2:    #5a7a96
   Red:      #d9534f
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --hdr:      #1f4d73;
  --nav:      #2a6496;
  --nav2:     #1f4d73;
  --accent:   #3b9fd4;
  --accent2:  #2e86b5;
  --yellow:   #f9c000;
  --yellow2:  #e0a800;
  --green:    #5cb85c;
  --red:      #d9534f;
  --red-bg:   #fdf1f0;
  --red-b:    #f5c6c5;
  --page:     #dde8f0;
  --card:     #ffffff;
  --card2:    #f0f6fb;
  --border:   #c5d8e8;
  --border2:  #a8c4d8;
  --text:     #2d3f50;
  --text2:    #5a7a96;
  --text3:    #8aaabb;
  --shadow:   0 2px 8px rgba(31,77,115,.12);
  --shadow-lg:0 4px 20px rgba(31,77,115,.18);
  --r:        4px;
  --rl:       8px;
  --sans:     'Ubuntu', sans-serif;
  --cond:     'Ubuntu Condensed', sans-serif;
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--sans);background:var(--page);color:var(--text);min-height:100vh;font-size:14px;line-height:1.5}

::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--page)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

.app{display:flex;flex-direction:column;min-height:100vh;max-width:860px;margin:0 auto}

/* â”€â”€ HEADER â”€â”€ */
.header{
  background:var(--hdr);
  padding:0 20px;
  height:56px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
  position:sticky;top:0;z-index:100;
}
.logo{
  font-family:var(--cond);
  font-size:24px;
  font-weight:700;
  color:var(--yellow);
  letter-spacing:.5px;
  text-shadow:0 1px 3px rgba(0,0,0,.3);
  display:flex;align-items:center;gap:10px;
  user-select:none;
}
.logo-icon{
  width:32px;height:32px;
  background:var(--yellow);
  border-radius:var(--r);
  display:flex;align-items:center;justify-content:center;
  font-size:16px;
  box-shadow:0 2px 4px rgba(0,0,0,.2);
}
.logo-sub{
  font-family:var(--sans);
  font-size:10px;
  font-weight:400;
  color:rgba(255,255,255,.55);
  letter-spacing:.5px;
  margin-top:2px;
}
.status-pill{
  display:flex;align-items:center;gap:6px;
  padding:5px 12px;
  border-radius:20px;
  font-size:11px;
  font-weight:700;
  letter-spacing:.5px;
  text-transform:uppercase;
  border:1px solid rgba(255,255,255,.2);
  color:rgba(255,255,255,.7);
  background:rgba(0,0,0,.2);
  transition:all .3s;
}
.status-pill.ok{color:#7ddd7d;border-color:rgba(125,221,125,.4);background:rgba(92,184,92,.15)}
.status-pill.err{color:#ff9090;border-color:rgba(255,144,144,.4);background:rgba(217,83,79,.15)}
.status-dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.status-pill.ok .status-dot{animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ NAV â”€â”€ */
.nav{
  background:var(--nav);
  display:flex;
  overflow-x:auto;
  scrollbar-width:none;
  position:sticky;top:56px;z-index:99;
  box-shadow:0 2px 4px rgba(0,0,0,.15);
}
.nav::-webkit-scrollbar{display:none}
.tab{
  flex:1;min-width:max-content;
  height:42px;padding:0 20px;
  font-family:var(--cond);
  font-size:13px;font-weight:700;
  letter-spacing:.5px;text-transform:uppercase;
  color:rgba(255,255,255,.7);
  background:none;border:none;
  border-bottom:3px solid transparent;
  cursor:pointer;transition:all .2s;
  white-space:nowrap;
}
.tab:hover{color:#fff;background:rgba(255,255,255,.08)}
.tab.active{
  color:#fff;
  border-bottom-color:var(--yellow);
  background:rgba(255,255,255,.12);
}

/* â”€â”€ CONTENT â”€â”€ */
.content{flex:1;padding:20px;display:flex;flex-direction:column;gap:16px}
.screen{animation:up .2s ease both}
@keyframes up{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ CARDS â”€â”€ */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--rl);
  box-shadow:var(--shadow);
}
.card-header{
  background:linear-gradient(135deg,var(--nav) 0%,var(--accent2) 100%);
  color:#fff;
  padding:12px 16px;
  border-radius:var(--rl) var(--rl) 0 0;
  font-family:var(--cond);
  font-size:14px;font-weight:700;
  letter-spacing:.5px;text-transform:uppercase;
  display:flex;align-items:center;gap:8px;
}
.card-body{padding:16px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  font-family:var(--sans);font-weight:700;font-size:13px;
  padding:8px 18px;border-radius:var(--r);border:1px solid;
  cursor:pointer;transition:all .15s;
  display:inline-flex;align-items:center;gap:6px;
  text-decoration:none;
}
.btn-blue{background:var(--accent);color:#fff;border-color:var(--accent2)}
.btn-blue:hover{background:var(--accent2);border-color:#1f6b94;transform:translateY(-1px);box-shadow:0 3px 8px rgba(59,159,212,.35)}
.btn-yellow{background:var(--yellow);color:#2d3f50;border-color:var(--yellow2)}
.btn-yellow:hover{background:var(--yellow2);transform:translateY(-1px);box-shadow:0 3px 8px rgba(249,192,0,.35)}
.btn-outline{background:#fff;color:var(--accent);border-color:var(--border2)}
.btn-outline:hover{background:var(--card2);border-color:var(--accent)}
.btn-ghost{background:transparent;color:var(--text2);border-color:transparent;padding:6px 10px}
.btn-ghost:hover{background:var(--card2);color:var(--text)}
.btn-red{background:var(--red);color:#fff;border-color:#c9302c}
.btn-red:hover{background:#c9302c;transform:translateY(-1px)}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.btn-sm{padding:5px 12px;font-size:12px}

/* â”€â”€ INPUTS â”€â”€ */
.input{
  width:100%;
  background:#fff;
  border:1px solid var(--border2);
  border-radius:var(--r);
  color:var(--text);
  font-family:var(--sans);font-size:14px;
  padding:9px 12px;
  transition:border-color .2s,box-shadow .2s;outline:none;
}
.input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,159,212,.2)}
.input::placeholder{color:var(--text3)}
textarea.input{resize:vertical;min-height:88px}
.label{
  display:block;
  font-size:12px;font-weight:700;
  color:var(--text2);
  margin-bottom:5px;
  text-transform:uppercase;letter-spacing:.4px;
}
.form-group{margin-bottom:14px}
.err-box{
  background:var(--red-bg);border:1px solid var(--red-b);
  border-radius:var(--r);padding:10px 14px;
  color:var(--red);font-size:13px;margin-bottom:12px;
}
.info-box{
  background:#f0f8ff;border:1px solid #bee3f8;
  border-radius:var(--r);padding:10px 14px;
  color:#2e6da4;font-size:13px;
}

/* badges */
.badge-pill{
  display:inline-flex;align-items:center;gap:4px;
  font-size:11px;font-weight:700;
  padding:3px 10px;border-radius:20px;
  border:1px solid;letter-spacing:.3px;
}
.badge-blue{color:var(--accent2);border-color:var(--border2);background:var(--card2)}
.badge-yellow{color:#856404;border-color:#ffe699;background:#fff9e0}
.badge-green{color:#285f28;border-color:#c3e6c3;background:#f0faf0}
.badge-red{color:#9b2222;border-color:#f5c6c5;background:var(--red-bg)}

/* spinner */
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-center{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 0;gap:12px;color:var(--text3);font-size:13px}
.loading-center .spinner{width:28px;height:28px;border-width:3px}

.empty-state{text-align:center;padding:48px 20px;color:var(--text3)}
.empty-state .emoji{font-size:40px;margin-bottom:12px}
.empty-state p{font-size:14px;line-height:1.6}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.home-hero{
  background:linear-gradient(135deg,var(--hdr) 0%,var(--accent2) 100%);
  border-radius:var(--rl);
  padding:32px 24px;
  color:#fff;
  box-shadow:var(--shadow-lg);
  text-align:center;
  position:relative;
  overflow:hidden;
}
.home-hero::before{
  content:'';
  position:absolute;inset:0;
  background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}
.home-hero h1{
  font-family:var(--cond);font-size:36px;font-weight:700;
  color:var(--yellow);text-shadow:0 2px 6px rgba(0,0,0,.3);
  margin-bottom:6px;position:relative;
}
.home-hero p{color:rgba(255,255,255,.8);font-size:14px;position:relative}
.home-cta{display:flex;gap:10px;justify-content:center;margin-top:20px;position:relative;flex-wrap:wrap}

.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.stat-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--rl);padding:16px;text-align:center;
  box-shadow:var(--shadow);
}
.stat-num{font-family:var(--cond);font-size:30px;font-weight:700;color:var(--nav);line-height:1;margin-bottom:4px}
.stat-label{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}

.top-list{}
.top-row{
  display:flex;align-items:center;gap:10px;
  padding:9px 12px;cursor:pointer;
  border-radius:var(--r);transition:background .15s;
  margin:0 -4px;
}
.top-row:hover{background:var(--card2)}
.top-rank{font-family:var(--cond);font-size:13px;font-weight:700;width:28px;text-align:center;color:var(--text3)}
.top-rank.g1{color:var(--yellow2)}
.top-rank.g2{color:#9e9e9e}
.top-rank.g3{color:#cd7f32}
.top-name{flex:1;font-weight:700;font-size:13px;color:var(--text)}
.top-cnt{font-size:12px;font-weight:700;color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FUNAS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.funas-toolbar{
  display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;gap:10px;
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--rl);padding:12px 16px;
  box-shadow:var(--shadow);
}
.toolbar-left{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.toolbar-title{font-family:var(--cond);font-size:18px;font-weight:700;color:var(--nav)}
.seg{display:flex;border:1px solid var(--border2);border-radius:var(--r);overflow:hidden}
.seg-btn{
  padding:6px 14px;font-size:12px;font-weight:700;
  background:#fff;color:var(--text2);border:none;cursor:pointer;transition:all .15s;
  border-right:1px solid var(--border2);
}
.seg-btn:last-child{border-right:none}
.seg-btn.active{background:var(--nav);color:#fff}
.seg-btn:hover:not(.active){background:var(--card2)}

.filter-banner{
  display:flex;align-items:center;gap:10px;
  background:#fff9e0;border:1px solid #ffe699;
  border-radius:var(--r);padding:8px 14px;
  font-size:13px;color:#856404;
}
.filter-banner strong{color:var(--nav)}
.filter-banner .close-btn{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--text3);font-size:16px;line-height:1;padding:0 2px}

/* Funa form card */
.funa-form-card{
  background:var(--card);border:1px solid var(--accent);
  border-radius:var(--rl);box-shadow:0 0 0 3px rgba(59,159,212,.1);
  overflow:hidden;
  animation:up .2s ease both;
}
.funa-form-header{
  background:linear-gradient(135deg,var(--nav),var(--accent2));
  color:#fff;padding:12px 16px;
  font-family:var(--cond);font-size:14px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;
  display:flex;align-items:center;gap:8px;
}
.funa-form-body{padding:16px}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.char-bar{height:3px;background:var(--border);border-radius:2px;margin-top:5px;overflow:hidden}
.char-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .2s,background .2s}
.char-fill.warn{background:var(--red)}
.char-info{font-size:11px;color:var(--text3);text-align:right;margin-top:3px}
.char-info.warn{color:var(--red)}

.upload-zone{
  border:2px dashed var(--border2);border-radius:var(--r);
  padding:14px;text-align:center;cursor:pointer;
  transition:all .2s;color:var(--text3);font-size:13px;
  background:#fafcfe;
}
.upload-zone:hover{border-color:var(--accent);color:var(--accent);background:#f0f8ff}
.preview-wrap{position:relative;display:inline-block;margin-top:8px}
.preview-wrap img{max-width:100%;max-height:200px;border-radius:var(--r);border:1px solid var(--border);display:block}
.preview-remove{
  position:absolute;top:-8px;right:-8px;
  width:22px;height:22px;border-radius:50%;
  background:var(--red);color:#fff;font-size:13px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;border:2px solid #fff;line-height:1;
}
.form-footer{display:flex;align-items:center;justify-content:space-between;padding-top:12px;border-top:1px solid var(--border)}

/* Funa card */
.funa-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--rl);box-shadow:var(--shadow);
  overflow:hidden;
  animation:up .2s ease both;
  transition:box-shadow .2s,border-color .2s;
}
.funa-card:hover{box-shadow:var(--shadow-lg);border-color:var(--border2)}

.funa-top{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px 0;gap:8px;flex-wrap:wrap;
}
.funa-who{display:flex;align-items:center;gap:8px}
.funa-author{
  font-size:12px;font-weight:700;color:var(--accent2);
  display:flex;align-items:center;gap:4px;
}
.funa-author.anon{color:var(--text3);font-style:italic}
.funa-time{font-size:11px;color:var(--text3)}

.funa-target-row{
  padding:0 14px;margin-top:8px;
  display:flex;align-items:center;gap:6px;
}
.funa-target-lbl{font-size:11px;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.4px}
.funa-target-name{
  font-size:13px;font-weight:700;color:var(--nav);
  background:var(--card2);border:1px solid var(--border);
  padding:2px 10px;border-radius:20px;
  cursor:pointer;transition:all .15s;
}
.funa-target-name:hover{background:var(--nav);color:#fff;border-color:var(--nav)}

.funa-content{
  padding:10px 14px;font-size:14px;color:var(--text);
  line-height:1.65;white-space:pre-wrap;word-break:break-word;
}
.funa-img{
  width:100%;max-height:400px;object-fit:contain;
  display:block;cursor:pointer;
  border-top:1px solid var(--border);
  transition:opacity .2s;
}
.funa-img:hover{opacity:.92}

.funa-footer{
  display:flex;align-items:center;gap:8px;
  padding:10px 14px;border-top:1px solid var(--border);
  background:var(--card2);
}
.vote-btn{
  display:flex;align-items:center;gap:5px;
  padding:6px 14px;border-radius:20px;
  border:1px solid var(--border2);background:#fff;
  cursor:pointer;font-size:12px;font-weight:700;
  color:var(--text2);transition:all .2s;
}
.vote-btn:hover{border-color:var(--accent);color:var(--accent)}
.vote-btn.si{color:#285f28;border-color:#c3e6c3;background:#f0faf0}
.vote-btn.no{color:#9b2222;border-color:var(--red-b);background:var(--red-bg)}

.vote-track{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.vote-fill{height:100%;background:linear-gradient(to right,var(--green),var(--accent));border-radius:3px;transition:width .4s ease}

/* Pagination */
.pagination{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 0}
.pg-btn{
  padding:6px 12px;border-radius:var(--r);
  border:1px solid var(--border2);background:#fff;
  color:var(--text2);font-size:12px;font-weight:700;
  cursor:pointer;transition:all .15s;
}
.pg-btn:hover:not(:disabled){border-color:var(--accent);color:var(--accent)}
.pg-btn.active{background:var(--nav);color:#fff;border-color:var(--nav)}
.pg-btn:disabled{opacity:.35;cursor:not-allowed}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   USUARIO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.search-row{display:flex;gap:8px}
.search-row .input{flex:1}

.profile-banner{
  background:linear-gradient(135deg,var(--hdr),var(--accent2));
  border-radius:var(--rl);
  padding:20px;color:#fff;
  display:flex;align-items:flex-start;gap:16px;
  box-shadow:var(--shadow-lg);
}
.avatar-frame{
  width:90px;height:120px;
  background:rgba(255,255,255,.15);
  border:2px solid rgba(255,255,255,.3);
  border-radius:var(--r);
  overflow:hidden;flex-shrink:0;
  display:flex;align-items:flex-end;justify-content:center;
}
.avatar-frame img{max-width:100%;image-rendering:pixelated}
.profile-info{flex:1}
.profile-name{font-family:var(--cond);font-size:26px;font-weight:700;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.2);line-height:1;margin-bottom:4px}
.profile-motto{font-size:13px;color:rgba(255,255,255,.75);font-style:italic;margin-bottom:10px}
.profile-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.profile-tag{
  font-size:11px;font-weight:700;
  padding:3px 10px;border-radius:20px;
  border:1px solid rgba(255,255,255,.3);
  background:rgba(255,255,255,.15);color:rgba(255,255,255,.9);
}
.profile-tag.online{background:rgba(92,184,92,.3);border-color:rgba(92,184,92,.5)}

.subtabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:16px}
.subtab{
  padding:10px 18px;font-size:13px;font-weight:700;
  color:var(--text2);background:none;border:none;
  border-bottom:3px solid transparent;cursor:pointer;
  margin-bottom:-2px;transition:all .2s;
}
.subtab:hover{color:var(--nav)}
.subtab.active{color:var(--nav);border-bottom-color:var(--nav)}

.info-table{}
.info-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border)}
.info-row:last-child{border-bottom:none}
.info-key{font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.3px}
.info-val{font-size:13px;font-weight:700;color:var(--text)}

/* Badges grid */
.badges-wrap{display:flex;flex-wrap:wrap;gap:8px;padding:4px 0}
.badge-box{
  width:54px;height:54px;
  background:var(--card2);border:1px solid var(--border);
  border-radius:var(--r);overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  cursor:default;transition:all .15s;position:relative;
}
.badge-box:hover{border-color:var(--accent);transform:scale(1.1);z-index:1;box-shadow:var(--shadow)}
.badge-box img{width:44px;height:44px;image-rendering:pixelated}
.badge-box-empty{font-size:9px;color:var(--text3);text-align:center;padding:4px;word-break:break-all;line-height:1.2}

/* Friends grid */
.friends-wrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;padding:4px 0}
.friend-card{
  background:var(--card2);border:1px solid var(--border);
  border-radius:var(--r);padding:10px;text-align:center;
  cursor:pointer;transition:all .15s;
}
.friend-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:var(--shadow)}
.friend-avatar{width:44px;height:60px;margin:0 auto 6px;background:var(--border);border-radius:4px;overflow:hidden;display:flex;align-items:flex-end;justify-content:center}
.friend-avatar img{max-width:100%;image-rendering:pixelated}
.friend-name{font-size:12px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)}
.friend-status{font-size:10px;margin-top:2px;font-weight:700}
.friend-status.on{color:var(--green)}
.friend-status.off{color:var(--text3)}

/* â”€â”€ LIGHTBOX â”€â”€ */
.lightbox{position:fixed;inset:0;z-index:999;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;cursor:zoom-out;animation:fadeIn .2s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.lightbox img{max-width:92vw;max-height:92vh;object-fit:contain;border-radius:var(--rl);box-shadow:0 20px 60px rgba(0,0,0,.7)}
.lightbox-x{position:absolute;top:16px;right:16px;width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.12);border:none;color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}

@media(max-width:520px){
  .content{padding:12px;gap:12px}
  .two-col,.stats-row{grid-template-columns:1fr}
  .profile-banner{flex-direction:column}
  .home-cta{flex-direction:column}
  .funas-toolbar{flex-direction:column;align-items:flex-start}
}
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <header class="header">
    <div>
      <div class="logo">
        <div class="logo-icon">ğŸ„</div>
        <div>
          HabboTracker
          <div class="logo-sub">by Fungi Â· habbo.es</div>
        </div>
      </div>
    </div>
    <div id="statusPill" class="status-pill">
      <div class="status-dot"></div><span>conectando...</span>
    </div>
  </header>

  <!-- NAV -->
  <nav class="nav">
    <button class="tab active" data-tab="home"    onclick="setTab('home')">ğŸ  Inicio</button>
    <button class="tab"        data-tab="funas"   onclick="setTab('funas')">ğŸ”¥ Funas</button>
    <button class="tab"        data-tab="usuario" onclick="setTab('usuario')">ğŸ‘¤ Usuario</button>
  </nav>

  <main class="content" id="content"></main>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" style="display:none" onclick="closeLB()">
  <button class="lightbox-x" onclick="closeLB()">âœ•</button>
  <img id="lbImg" src="" alt="">
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = (() => {
  const h = window.location.hostname;
  return (h === 'localhost' || h === '127.0.0.1')
    ? 'http://localhost:3001'
    : 'https://habbotracker.onrender.com';
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  tab: 'home',
  home:  { stats: null, loading: false },
  funas: {
    items: [], total: 0, page: 1, pages: 1,
    sort: 'new', filter: null,
    loading: false, err: null,
    formOpen: false, formTarget: '', formContent: '',
    formHabbo: '', formFile: null, formPreview: null,
    formErr: null, formLoading: false,
  },
  user: {
    q: '', loading: false, err: null,
    data: null,      // resultado de /api/users/:name  (uniqueId + selectedBadges incluidos)
    friends: null,   // null = no cargado
    sub: 'info',
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiFetch(path, opts = {}) {
  const r = await fetch(API + path, { signal: AbortSignal.timeout(12000), ...opts });
  const d = await r.json().catch(() => ({}));
  if (!r.ok) throw new Error(d.error || `Error ${r.status}`);
  return d;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEALTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function checkHealth() {
  const el = document.getElementById('statusPill');
  try {
    await apiFetch('/health');
    el.className = 'status-pill ok';
    el.innerHTML = '<div class="status-dot"></div><span>API OK</span>';
  } catch {
    el.className = 'status-pill err';
    el.innerHTML = '<div class="status-dot"></div><span>Sin API</span>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTab(tab) {
  S.tab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  if (tab === 'funas'   && !S.funas.items.length   && !S.funas.loading)  loadFunas();
  if (tab === 'home'    && !S.home.stats            && !S.home.loading)   loadStats();
  render();
}

function render() {
  const el = document.getElementById('content');
  const fn = { home: renderHome, funas: renderFunas, usuario: renderUsuario }[S.tab] || renderHome;
  el.innerHTML = `<div class="screen">${fn()}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome() {
  const st = S.home.stats;
  return `
  <div class="home-hero">
    <h1>ğŸ„ HabboTracker</h1>
    <p>Explorador no oficial de la comunidad Habbo.es</p>
    <div class="home-cta">
      <button class="btn btn-yellow" onclick="setTab('funas')">ğŸ”¥ Ver funas</button>
      <button class="btn btn-outline" style="color:#fff;border-color:rgba(255,255,255,.5);background:rgba(255,255,255,.1)" onclick="setTab('usuario')">ğŸ‘¤ Buscar usuario</button>
    </div>
  </div>

  ${S.home.loading ? `<div class="loading-center"><div class="spinner"></div><span>Cargando estadÃ­sticas...</span></div>` : ''}

  ${st ? `
  <div class="stats-row">
    <div class="stat-card"><div class="stat-num">${st.totalFunas}</div><div class="stat-label">ğŸ”¥ Funas publicadas</div></div>
    <div class="stat-card"><div class="stat-num">${st.conNombre}</div><div class="stat-label">âœï¸ Con firma</div></div>
    <div class="stat-card"><div class="stat-num">${st.conImagen}</div><div class="stat-label">ğŸ“¸ Con imagen</div></div>
  </div>

  ${st.topFunados?.length ? `
  <div class="card">
    <div class="card-header">ğŸ† Ranking de mÃ¡s funados</div>
    <div class="card-body top-list">
      ${st.topFunados.map((f,i) => `
        <div class="top-row" onclick="goByTarget('${esc(f.name)}')">
          <div class="top-rank ${i===0?'g1':i===1?'g2':i===2?'g3':''}">${i===0?'ğŸ‘‘':i+1}</div>
          <div class="top-name">${esc(f.name)}</div>
          <div class="top-cnt">ğŸ”¥ ${f.count} funa${f.count!==1?'s':''}</div>
        </div>
      `).join('')}
    </div>
  </div>` : ''}
  ` : ''}`;
}

async function loadStats() {
  S.home.loading = true; render();
  try { S.home.stats = await apiFetch('/funas/stats'); } catch {}
  S.home.loading = false; render();
}

function goByTarget(name) {
  S.funas.filter = name; S.funas.page = 1;
  setTab('funas'); loadFunas();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFunas() {
  const f = S.funas;
  return `
  <div class="funas-toolbar">
    <div class="toolbar-left">
      <span class="toolbar-title">ğŸ”¥ Funas</span>
      <div class="seg">
        <button class="seg-btn ${f.sort==='new'?'active':''}" onclick="setSort('new')">Recientes</button>
        <button class="seg-btn ${f.sort==='top'?'active':''}" onclick="setSort('top')">MÃ¡s votadas</button>
      </div>
    </div>
    <button class="btn btn-blue ${f.formOpen?'btn-outline':''}" onclick="toggleForm()">
      ${f.formOpen ? 'âœ• Cancelar' : '+ Nueva funa'}
    </button>
  </div>

  ${f.filter ? `
  <div class="filter-banner">
    ğŸ” Mostrando funas de: <strong>${esc(f.filter)}</strong>
    <button class="close-btn" onclick="clearFilter()">âœ•</button>
  </div>` : ''}

  ${f.formOpen ? renderForm() : ''}

  ${f.loading
    ? `<div class="loading-center"><div class="spinner"></div><span>Cargando funas...</span></div>`
    : f.err
    ? `<div class="err-box">âš ï¸ ${esc(f.err)}</div>`
    : f.items.length === 0
    ? `<div class="empty-state"><div class="emoji">ğŸ˜¶</div><p>No hay funas todavÃ­a.<br>Â¡SÃ© el primero en publicar!</p></div>`
    : f.items.map(renderFunaCard).join('')}

  ${f.pages > 1 ? renderPager(f.page, f.pages) : ''}`;
}

function renderForm() {
  const f = S.funas;
  const len = f.formContent.length;
  return `
  <div class="funa-form-card">
    <div class="funa-form-header">ğŸ“¢ Nueva denuncia pÃºblica</div>
    <div class="funa-form-body">
      ${f.formErr ? `<div class="err-box">${esc(f.formErr)}</div>` : ''}
      <div class="two-col">
        <div class="form-group">
          <label class="label">Â¿A quiÃ©n funas? (opcional)</label>
          <input class="input" placeholder="Nombre en Habbo..." value="${esc(f.formTarget)}" oninput="S.funas.formTarget=this.value">
        </div>
        <div class="form-group">
          <label class="label">Tu nombre (opcional)</label>
          <input class="input" placeholder="Dejar en blanco = anÃ³nimo" value="${esc(f.formHabbo)}" oninput="S.funas.formHabbo=this.value">
        </div>
      </div>
      <div class="form-group">
        <label class="label">Denuncia <span style="color:var(--red)">*</span></label>
        <textarea class="input" placeholder="ContÃ¡ quÃ© pasÃ³... sÃ© especÃ­fico (mÃ­nimo 5 caracteres)" maxlength="500"
          oninput="S.funas.formContent=this.value;updateBar()">${esc(f.formContent)}</textarea>
        <div class="char-bar"><div class="char-fill${len>440?' warn':''}" id="charFill" style="width:${len/5}%"></div></div>
        <div class="char-info${len>440?' warn':''}">${len}/500</div>
      </div>
      <div class="form-group">
        <label class="label">Evidencia (imagen Â· opcional)</label>
        ${f.formPreview ? `
          <div class="preview-wrap">
            <img src="${f.formPreview}" alt="">
            <button class="preview-remove" onclick="removeImg()">âœ•</button>
          </div>` : `
          <div class="upload-zone" onclick="document.getElementById('fFile').click()">
            ğŸ“ Clic para subir captura de pantalla<br><span style="font-size:11px">JPG, PNG, GIF, WEBP Â· mÃ¡x 5 MB</span>
          </div>
          <input type="file" id="fFile" accept="image/*" style="display:none" onchange="pickFile(event)">`}
      </div>
      <div class="form-footer">
        <span style="font-size:12px;color:var(--text3)">ğŸ•µï¸ AnÃ³nimo por defecto si no ponÃ©s tu nombre</span>
        <button class="btn btn-blue" onclick="submitFuna()" ${f.formLoading?'disabled':''}>
          ${f.formLoading ? '<div class="spinner" style="width:15px;height:15px;border-width:2px;margin:0"></div>' : 'ğŸ”¥ Publicar'}
        </button>
      </div>
    </div>
  </div>`;
}

function renderFunaCard(funa) {
  const si = funa.votesSi||0, no = funa.votesNo||0, tot = si+no;
  const pct = tot > 0 ? Math.round(si/tot*100) : 50;
  return `
  <div class="funa-card">
    <div class="funa-top">
      <div class="funa-who">
        <span class="funa-author ${funa.habboName?'':'anon'}">
          ${funa.habboName ? `<span>ğŸ‘¤</span> ${esc(funa.habboName)}` : '<span>ğŸ•µï¸</span> AnÃ³nimo'}
        </span>
        <span class="funa-time">Â· ${timeAgo(funa.createdAt)}</span>
      </div>
      ${funa.target ? `<span class="badge-pill badge-red" style="font-size:10px">ğŸ¯ Funa</span>` : `<span class="badge-pill badge-blue" style="font-size:10px">ğŸ“¢ Denuncia</span>`}
    </div>

    ${funa.target ? `
    <div class="funa-target-row">
      <span class="funa-target-lbl">Funa a:</span>
      <span class="funa-target-name" onclick="goByTarget('${esc(funa.target)}')">${esc(funa.target)}</span>
    </div>` : ''}

    <div class="funa-content">${esc(funa.content)}</div>

    ${funa.imageUrl ? `<img class="funa-img" src="${API}${funa.imageUrl}" alt="Evidencia" onclick="openLB('${API}${funa.imageUrl}')" onerror="this.style.display='none'">` : ''}

    <div class="funa-footer">
      <button class="vote-btn ${funa.myVote==='si'?'si':''}" onclick="vote('${funa.id}','si')">ğŸ‘ ${si}</button>
      <div class="vote-track"><div class="vote-fill" style="width:${pct}%"></div></div>
      <button class="vote-btn ${funa.myVote==='no'?'no':''}" onclick="vote('${funa.id}','no')">ğŸ‘ ${no}</button>
    </div>
  </div>`;
}

function renderPager(page, pages) {
  let h = `<button class="pg-btn" onclick="goPage(${page-1})" ${page<=1?'disabled':''}>â€¹</button>`;
  const s = Math.max(1,page-2), e = Math.min(pages,page+2);
  if (s>1) h += `<button class="pg-btn" onclick="goPage(1)">1</button>${s>2?'<span style="color:var(--text3);padding:0 4px">â€¦</span>':''}`;
  for(let i=s;i<=e;i++) h += `<button class="pg-btn ${i===page?'active':''}" onclick="goPage(${i})">${i}</button>`;
  if (e<pages) h += `${e<pages-1?'<span style="color:var(--text3);padding:0 4px">â€¦</span>':''}<button class="pg-btn" onclick="goPage(${pages})">${pages}</button>`;
  h += `<button class="pg-btn" onclick="goPage(${page+1})" ${page>=pages?'disabled':''}>â€º</button>`;
  return `<div class="pagination">${h}</div>`;
}

function setSort(s) { S.funas.sort=s; S.funas.page=1; render(); loadFunas(); }
function goPage(p) { S.funas.page=p; loadFunas(); window.scrollTo({top:0,behavior:'smooth'}); }
function clearFilter() { S.funas.filter=null; S.funas.page=1; loadFunas(); }
function toggleForm() {
  S.funas.formOpen = !S.funas.formOpen;
  if (!S.funas.formOpen) resetForm();
  render();
}
function resetForm() { Object.assign(S.funas,{formTarget:'',formContent:'',formHabbo:'',formFile:null,formPreview:null,formErr:null,formLoading:false}); }
function updateBar() {
  const len = S.funas.formContent.length;
  const fill = document.getElementById('charFill');
  if (fill) { fill.style.width = (len/5)+'%'; fill.className = 'char-fill'+(len>440?' warn':''); }
}
function pickFile(e) {
  const f = e.target.files[0]; if (!f) return;
  S.funas.formFile = f;
  const r = new FileReader();
  r.onload = ev => { S.funas.formPreview = ev.target.result; render(); };
  r.readAsDataURL(f);
}
function removeImg() { S.funas.formFile=null; S.funas.formPreview=null; render(); }

async function submitFuna() {
  const f = S.funas;
  if (!f.formContent.trim() || f.formContent.trim().length < 5) { f.formErr='MÃ­nimo 5 caracteres'; render(); return; }
  f.formLoading=true; f.formErr=null; render();
  try {
    const fd = new FormData();
    fd.append('content', f.formContent.trim());
    if (f.formTarget.trim()) fd.append('target', f.formTarget.trim());
    if (f.formHabbo.trim())  fd.append('habboName', f.formHabbo.trim());
    if (f.formFile)          fd.append('image', f.formFile, f.formFile.name);
    const r = await fetch(API+'/funas',{method:'POST',body:fd});
    const d = await r.json().catch(()=>({}));
    if (!r.ok) throw new Error(d.error||`Error ${r.status}`);
    f.items.unshift(d); f.total++;
    f.formOpen=false; resetForm();
    S.home.stats=null;
    render();
  } catch(e) { f.formErr=e.message; }
  f.formLoading=false; render();
}

async function loadFunas() {
  const f = S.funas;
  f.loading=true; f.err=null; render();
  try {
    const p = new URLSearchParams({page:f.page,sort:f.sort});
    if (f.filter) p.set('target',f.filter);
    const d = await apiFetch('/funas?'+p);
    Object.assign(f,{items:d.items,total:d.total,page:d.page,pages:d.pages});
  } catch(e) { f.err=e.message; }
  f.loading=false; render();
}

async function vote(id, v) {
  try {
    const d = await apiFetch(`/funas/${id}/vote`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({vote:v})});
    const funa = S.funas.items.find(f=>f.id===id);
    if (funa) { funa.votesSi=d.votesSi; funa.votesNo=d.votesNo; funa.myVote=d.myVote; render(); }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USUARIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderUsuario() {
  const u = S.user;
  return `
  <div class="card">
    <div class="card-header">ğŸ‘¤ Buscar jugador de Habbo.es</div>
    <div class="card-body">
      <div class="search-row">
        <input class="input" placeholder="Nombre exacto en Habbo.es..." value="${esc(u.q)}"
          oninput="S.user.q=this.value" onkeydown="if(event.key==='Enter')searchUser()">
        <button class="btn btn-blue" onclick="searchUser()" ${u.loading?'disabled':''}>
          ${u.loading ? '<div class="spinner" style="width:15px;height:15px;border-width:2px;margin:0"></div>' : 'Buscar'}
        </button>
      </div>
      ${u.err ? `<div class="err-box" style="margin-top:12px">âš ï¸ ${esc(u.err)}</div>` : ''}
    </div>
  </div>

  ${u.data && !u.loading ? renderProfile() : !u.data && !u.loading && !u.err ? `
  <div class="empty-state">
    <div class="emoji">ğŸ”</div>
    <p>IngresÃ¡ el nombre exacto de un jugador<br>para ver su perfil, placas y amigos.</p>
  </div>` : ''}`;
}

function renderProfile() {
  const u = S.user, p = u.data;
  const name = p.name || '';
  const fig  = p.figureString || '';
  const priv = p.profileVisible === false;

  return `
  <div class="profile-banner">
    <div class="avatar-frame">
      ${fig ? `<img src="${API}/avatar?figure=${encodeURIComponent(fig)}&size=l" alt="${esc(name)}" onerror="this.style.display='none'">` : ''}
    </div>
    <div class="profile-info">
      <div class="profile-name">${esc(name)}</div>
      ${p.motto ? `<div class="profile-motto">"${esc(p.motto)}"</div>` : ''}
      <div class="profile-tags">
        ${p.online!=null ? `<span class="profile-tag ${p.online?'online':''}">${p.online?'ğŸŸ¢ En lÃ­nea':'âš« Desconectado'}</span>` : ''}
        ${p.memberSince  ? `<span class="profile-tag">ğŸ“… Desde ${p.memberSince.slice(0,7)}</span>` : ''}
        ${p.currentLevel != null ? `<span class="profile-tag">â­ Nv. ${p.currentLevel}</span>` : ''}
        ${priv ? `<span class="profile-tag" style="background:rgba(217,83,79,.3);border-color:rgba(217,83,79,.5)">ğŸ”’ Perfil privado</span>` : ''}
      </div>
      <button class="btn btn-yellow btn-sm" onclick="prefillFuna('${esc(name)}')">ğŸ”¥ Funar a ${esc(name)}</button>
    </div>
  </div>

  ${priv ? `<div class="info-box">ğŸ”’ Este jugador tiene el perfil privado. Las placas y amigos no estÃ¡n disponibles.</div>` : ''}

  <div class="card">
    <div class="subtabs">
      <button class="subtab ${u.sub==='info'?'active':''}"    onclick="setSub('info')">Info</button>
      <button class="subtab ${u.sub==='badges'?'active':''}"  onclick="setSub('badges')">Placas</button>
      ${!priv ? `<button class="subtab ${u.sub==='friends'?'active':''}" onclick="setSub('friends')">Amigos</button>` : ''}
    </div>
    <div class="card-body">
      ${u.sub==='info'    ? renderInfo()    :
        u.sub==='badges'  ? renderBadges()  :
        u.sub==='friends' ? renderFriends() : ''}
    </div>
  </div>`;
}

function renderInfo() {
  const p = S.user.data;
  const rows = [
    ['Nivel', p.currentLevel != null ? `Nv. ${p.currentLevel} (${p.currentLevelCompletePercent||0}%)` : null],
    ['Experiencia', p.totalExperience],
    ['Star gems', p.starGemCount],
    ['Miembro desde', p.memberSince?.slice(0,10)],
    ['Ãšltimo acceso', p.lastAccessTime?.slice(0,10)],
  ].filter(([,v]) => v != null && v !== '');
  if (!rows.length) return `<div class="empty-state" style="padding:24px"><div class="emoji" style="font-size:28px">ğŸ“­</div><p>Sin info adicional visible</p></div>`;
  return `<div class="info-table">${rows.map(([k,v])=>`<div class="info-row"><span class="info-key">${k}</span><span class="info-val">${esc(String(v))}</span></div>`).join('')}</div>`;
}

function renderBadges() {
  // selectedBadges ya viene en los datos del lookup inicial
  const badges = S.user.data?.selectedBadges || [];
  if (!badges.length) return `<div class="empty-state" style="padding:24px"><div class="emoji" style="font-size:28px">ğŸ…</div><p>Sin placas seleccionadas visibles</p></div>`;
  return `<div class="badges-wrap">${badges.map(b => {
    const code = b.code || b.badgeCode || '';
    return `<div class="badge-box" title="${esc(b.name||b.badgeName||code)}">
      ${code ? `<img src="${API}/badge/${code}" alt="${esc(code)}" onerror="this.outerHTML='<div class=badge-box-empty>${esc(code)}</div>'">` : '<div class="badge-box-empty">?</div>'}
    </div>`;
  }).join('')}</div>`;
}

function renderFriends() {
  const u = S.user;
  if (u.friends === null) { loadFriends(); return `<div class="loading-center"><div class="spinner"></div><span>Cargando amigos...</span></div>`; }
  if (!u.friends.length) return `<div class="empty-state" style="padding:24px"><div class="emoji" style="font-size:28px">ğŸ‘¥</div><p>Sin amigos visibles</p></div>`;
  return `<div class="friends-wrap">${u.friends.map(f => {
    const nm = f.name||'';
    const fig = f.figureString||'';
    return `<div class="friend-card" onclick="loadFriend('${esc(nm)}')">
      <div class="friend-avatar">${fig?`<img src="${API}/avatar?figure=${encodeURIComponent(fig)}&size=s" onerror="this.style.display='none'" alt="">`:''}</div>
      <div class="friend-name">${esc(nm)}</div>
      <div class="friend-status ${f.online?'on':'off'}">${f.online?'ğŸŸ¢ En lÃ­nea':'âš« Offline'}</div>
    </div>`;
  }).join('')}</div>`;
}

async function searchUser() {
  const q = S.user.q.trim();
  if (!q) return;
  Object.assign(S.user, {loading:true,err:null,data:null,friends:null,sub:'info'});
  render();
  try {
    // Un solo call: /api/users/:name devuelve todo (uniqueId, figureString, selectedBadges, etc.)
    S.user.data = await apiFetch(`/api/users/${encodeURIComponent(q)}`);
  } catch(e) { S.user.err = e.message; }
  S.user.loading = false; render();
}

async function loadFriends() {
  const uid = S.user.data?.uniqueId;
  if (!uid) { S.user.friends = []; render(); return; }
  try {
    const d = await apiFetch(`/api/users/${encodeURIComponent(uid)}/friends`);
    S.user.friends = Array.isArray(d) ? d : [];
  } catch { S.user.friends = []; }
  render();
}

function setSub(s) { S.user.sub=s; render(); }
function loadFriend(name) { S.user.q=name; Object.assign(S.user,{data:null,friends:null,sub:'info'}); searchUser(); }

function prefillFuna(name) {
  S.funas.formOpen=true; S.funas.formTarget=name;
  setTab('funas');
  setTimeout(()=>document.querySelector('.funa-form-body textarea')?.focus(), 100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLB(src) {
  document.getElementById('lbImg').src = src;
  document.getElementById('lightbox').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
function closeLB() {
  document.getElementById('lightbox').style.display = 'none';
  document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if (e.key==='Escape') closeLB(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
  return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function timeAgo(ts) {
  const m = Math.floor((Date.now()-ts)/60000);
  if (m<1)  return 'ahora mismo';
  if (m<60) return `hace ${m}m`;
  const h = Math.floor(m/60);
  if (h<24) return `hace ${h}h`;
  const d = Math.floor(h/24);
  if (d<30) return `hace ${d}d`;
  return new Date(ts).toLocaleDateString('es-ES',{day:'numeric',month:'short'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
render();
checkHealth();
loadStats();
</script>
</body>
</html>
